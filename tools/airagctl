#!/usr/bin/env bash
# =============================================================================
# airagctl - AI RAG Control Tool
# =============================================================================
# Main CLI tool for managing the AI RAG system
# Similar to your policyctl for BYU policy system
#
# Usage:
#   airagctl start              Start all services
#   airagctl stop               Stop all services
#   airagctl restart            Restart all services
#   airagctl status             Check service status
#   airagctl logs [service]     View service logs
#   airagctl crawl <url>        Crawl a website
#   airagctl ask <question>     Ask a question
#   airagctl health             Check system health
#   airagctl reset              Reset vector database
#   airagctl backup             Backup database
#   airagctl restore <file>     Restore from backup
#   airagctl dev                Start in dev mode

set -e

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

# Configuration
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(dirname "$SCRIPT_DIR")"
COMPOSE_FILE="$PROJECT_ROOT/docker-compose.yml"

# =============================================================================
# Helper Functions
# =============================================================================

print_header() {
    echo -e "${CYAN}========================================${NC}"
    echo -e "${CYAN}$1${NC}"
    echo -e "${CYAN}========================================${NC}"
}

print_success() {
    echo -e "${GREEN}✓${NC} $1"
}

print_error() {
    echo -e "${RED}✗${NC} $1"
}

print_warning() {
    echo -e "${YELLOW}⚠${NC} $1"
}

print_info() {
    echo -e "${BLUE}ℹ${NC} $1"
}

check_docker() {
    if ! command -v docker &> /dev/null; then
        print_error "Docker is not installed"
        exit 1
    fi
    
    if ! docker ps &> /dev/null; then
        print_error "Docker daemon is not running"
        exit 1
    fi
}

check_compose() {
    if ! command -v docker &> /dev/null || ! docker compose version &> /dev/null; then
        print_error "Docker Compose is not installed"
        exit 1
    fi
}

# =============================================================================
# Service Management
# =============================================================================

start_services() {
    print_header "Starting AI RAG Services"
    check_docker
    check_compose
    
    cd "$PROJECT_ROOT"
    
    print_info "Building images..."
    docker compose build
    
    print_info "Starting services..."
    docker compose up -d
    
    print_success "Services started"
    
    # Wait for services to be healthy
    print_info "Waiting for services to be healthy..."
    sleep 5
    
    show_status
}

stop_services() {
    print_header "Stopping AI RAG Services"
    check_docker
    check_compose
    
    cd "$PROJECT_ROOT"
    docker compose down
    
    print_success "Services stopped"
}

restart_services() {
    print_header "Restarting AI RAG Services"
    stop_services
    sleep 2
    start_services
}

show_status() {
    print_header "Service Status"
    check_docker
    check_compose
    
    cd "$PROJECT_ROOT"
    docker compose ps
}

show_logs() {
    local service=$1
    check_docker
    check_compose
    
    cd "$PROJECT_ROOT"
    
    if [ -z "$service" ]; then
        print_info "Showing logs for all services (Ctrl+C to exit)"
        docker compose logs -f
    else
        print_info "Showing logs for $service (Ctrl+C to exit)"
        docker compose logs -f "$service"
    fi
}

# =============================================================================
# Operations
# =============================================================================

crawl_website() {
    local url=$1
    
    if [ -z "$url" ]; then
        print_error "URL required"
        echo "Usage: airagctl crawl <url>"
        exit 1
    fi
    
    print_header "Crawling Website"
    print_info "URL: $url"
    
    check_docker
    cd "$PROJECT_ROOT"
    
    docker compose run --rm crawler python /app/cli.py crawl --url "$url"
    
    print_success "Crawl complete"
}

ask_question() {
    local question=$1
    
    if [ -z "$question" ]; then
        print_error "Question required"
        echo "Usage: airagctl ask \"Your question here\""
        exit 1
    fi
    
    print_header "Asking Question"
    print_info "Question: $question"
    echo
    
    # Check if orchestrator is running
    if ! curl -s http://localhost:8000/health > /dev/null 2>&1; then
        print_error "Orchestrator API is not running"
        print_info "Start services with: airagctl start"
        exit 1
    fi
    
    # Make request
    response=$(curl -s -X POST http://localhost:8000/ask \
        -H "Content-Type: application/json" \
        -d "{\"question\": \"$question\", \"stream\": false}")
    
    # Parse and display
    answer=$(echo "$response" | jq -r '.answer // empty')
    
    if [ -n "$answer" ]; then
        echo -e "${GREEN}Answer:${NC}"
        echo "$answer"
        echo
        
        # Show citations if present
        citations=$(echo "$response" | jq -r '.citations // empty')
        if [ -n "$citations" ] && [ "$citations" != "null" ]; then
            echo -e "${CYAN}Sources:${NC}"
            echo "$response" | jq -r '.citations[] | "[\(.source_number)] \(.title) - \(.url)"'
        fi
    else
        print_error "Failed to get answer"
        echo "$response" | jq .
    fi
}

check_health() {
    print_header "System Health Check"
    
    # Check orchestrator
    echo -e "${BLUE}Orchestrator API:${NC}"
    if curl -s http://localhost:8000/health > /dev/null 2>&1; then
        health=$(curl -s http://localhost:8000/health | jq .)
        print_success "Running"
        echo "$health" | jq -C .
    else
        print_error "Not responding"
    fi
    echo
    
    # Check worker
    echo -e "${BLUE}Worker API:${NC}"
    if curl -s http://localhost:8001/health > /dev/null 2>&1; then
        health=$(curl -s http://localhost:8001/health | jq .)
        print_success "Running"
        echo "$health" | jq -C .
    else
        print_error "Not responding"
    fi
    echo
    
    # Check frontend
    echo -e "${BLUE}Frontend:${NC}"
    if curl -s http://localhost:8080/health > /dev/null 2>&1; then
        print_success "Running at http://localhost:8080"
    else
        print_error "Not responding"
    fi
    echo
    
    # Check Qdrant
    echo -e "${BLUE}Qdrant Vector DB:${NC}"
    if curl -s http://localhost:6333/health > /dev/null 2>&1; then
        print_success "Running"
    else
        print_error "Not responding"
    fi
}

reset_database() {
    print_header "Reset Vector Database"
    print_warning "This will delete ALL crawled data!"
    
    read -p "Are you sure? (yes/no): " confirm
    
    if [ "$confirm" != "yes" ]; then
        print_info "Aborted"
        exit 0
    fi
    
    check_docker
    cd "$PROJECT_ROOT"
    
    print_info "Resetting database..."
    docker compose run --rm crawler python /app/cli.py reset --yes
    
    print_success "Database reset complete"
}

backup_database() {
    print_header "Backup Vector Database"
    
    local backup_dir="$PROJECT_ROOT/backups"
    local timestamp=$(date +%Y%m%d_%H%M%S)
    local backup_file="$backup_dir/qdrant_backup_$timestamp.tar.gz"
    
    mkdir -p "$backup_dir"
    
    check_docker
    cd "$PROJECT_ROOT"
    
    print_info "Creating backup..."
    
    # Stop Qdrant temporarily
    docker compose stop qdrant
    
    # Create backup
    docker run --rm \
        -v airag_qdrant_data:/data \
        -v "$backup_dir":/backup \
        alpine tar czf "/backup/qdrant_backup_$timestamp.tar.gz" -C /data .
    
    # Restart Qdrant
    docker compose start qdrant
    
    print_success "Backup created: $backup_file"
}

restore_database() {
    local backup_file=$1
    
    if [ -z "$backup_file" ]; then
        print_error "Backup file required"
        echo "Usage: airagctl restore <backup_file>"
        exit 1
    fi
    
    if [ ! -f "$backup_file" ]; then
        print_error "Backup file not found: $backup_file"
        exit 1
    fi
    
    print_header "Restore Vector Database"
    print_warning "This will overwrite current data!"
    
    read -p "Are you sure? (yes/no): " confirm
    
    if [ "$confirm" != "yes" ]; then
        print_info "Aborted"
        exit 0
    fi
    
    check_docker
    cd "$PROJECT_ROOT"
    
    print_info "Restoring from backup..."
    
    # Stop Qdrant
    docker compose stop qdrant
    
    # Restore data
    docker run --rm \
        -v airag_qdrant_data:/data \
        -v "$(dirname "$backup_file")":/backup \
        alpine sh -c "cd /data && tar xzf /backup/$(basename "$backup_file")"
    
    # Start Qdrant
    docker compose start qdrant
    
    print_success "Restore complete"
}

dev_mode() {
    print_header "Development Mode"
    check_docker
    check_compose
    
    cd "$PROJECT_ROOT"
    
    print_info "Starting services in dev mode..."
    docker compose -f docker-compose.yml -f docker-compose.dev.yml up
}

# =============================================================================
# Help
# =============================================================================

show_help() {
    cat << EOF
${CYAN}airagctl${NC} - AI RAG Control Tool

${YELLOW}Usage:${NC}
  airagctl <command> [options]

${YELLOW}Service Management:${NC}
  start                 Start all services
  stop                  Stop all services
  restart               Restart all services
  status                Show service status
  logs [service]        View service logs (optional: specify service)
  dev                   Start in development mode

${YELLOW}Operations:${NC}
  crawl <url>           Crawl a website and ingest content
  ask <question>        Ask a question (non-streaming)
  health                Check system health
  reset                 Reset vector database (deletes all data)
  backup                Backup vector database
  restore <file>        Restore database from backup

${YELLOW}Examples:${NC}
  airagctl start
  airagctl crawl https://docs.example.com
  airagctl ask "What is the per diem rate for Denver?"
  airagctl logs orchestrator-api
  airagctl backup
  airagctl restore backups/qdrant_backup_20250113_120000.tar.gz

${YELLOW}URLs:${NC}
  Frontend:      http://localhost:8080
  Orchestrator:  http://localhost:8000
  Worker:        http://localhost:8001
  Qdrant:        http://localhost:6333

${YELLOW}Help:${NC}
  airagctl help         Show this help message
  airagctl --help
  airagctl -h

EOF
}

# =============================================================================
# Main
# =============================================================================

main() {
    if [ $# -eq 0 ]; then
        show_help
        exit 0
    fi
    
    case "$1" in
        start)
            start_services
            ;;
        stop)
            stop_services
            ;;
        restart)
            restart_services
            ;;
        status)
            show_status
            ;;
        logs)
            show_logs "$2"
            ;;
        crawl)
            crawl_website "$2"
            ;;
        ask)
            ask_question "$2"
            ;;
        health)
            check_health
            ;;
        reset)
            reset_database
            ;;
        backup)
            backup_database
            ;;
        restore)
            restore_database "$2"
            ;;
        dev)
            dev_mode
            ;;
        help|--help|-h)
            show_help
            ;;
        *)
            print_error "Unknown command: $1"
            echo
            show_help
            exit 1
            ;;
    esac
}

main "$@"
